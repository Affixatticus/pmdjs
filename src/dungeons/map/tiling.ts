import { Tile } from "../../data/tiles";
import { CropParams } from "../../utils/canvas";

/** Value to index each type of tiling encounterable */
export enum Tiling {
    NORTH_WEST_FULL,
    NORTH_FULL,
    NORTH_EAST_FULL,
    WEST_FULL,
    CENTER_FULL,
    EAST_FULL,
    SOUTH_WEST_FULL,
    SOUTH_FULL,
    SOUTH_EAST_FULL,

    SOUTH_TO_EAST_JUNCTION_THIN,
    HORIZONTAL_THIN,
    SOUTH_TO_WEST_JUNCTION_THIN,
    VERTICAL_THIN,
    CENTER_THIN,
    ___UNUSED_1___,
    NORTH_TO_EAST_JUNCTION_THIN,
    ___UNUSED_2___,
    NORTH_TO_WEST_JUNCTION_THIN,

    ___UNUSED_3___,
    END_NORTH_JUNCTION_THIN,
    ___UNUSED_4___,
    END_WEST_JUNCTION_THIN,
    FOUR_WAY_JUNCTION_THIN,
    END_EAST_JUNCTION_THIN,
    ___UNUSED_5___,
    END_SOUTH_JUNCTION_THIN,
    ___UNUSED_6___,

    ___UNUSED_7___,
    HORIZONTAL_TO_SOUTH_JUNCTION_THIN,
    ___UNUSED_8___,
    VERTICAL_TO_EAST_JUNCTION_THIN,
    ___UNUSED_9___,
    VERTICAL_TO_WEST_JUNCTION_THIN,
    ___UNUSED_10___,
    HORIZONTAL_TO_NORTH_JUNCTION_THIN,
    ___UNUSED_11___,

    ___UNUSED_12___,
    NORTH_TO_SOUTH_JUNCTIONS_FULL,
    ___UNUSED_13___,
    WEST_TO_EAST_JUNCTIONS_FULL,
    ___UNUSED_14___,
    EAST_TO_WEST_JUNCTIONS_FULL,
    ___UNUSED_15___,
    SOUTH_TO_NORTH_JUNCTIONS_FULL,
    ___UNUSED_16___,

    SOUTH_EAST_CORNER_EMPTY,
    SOUTH_WEST_CORNER_EMPTY,
    ___UNUSED_17___,
    NORTH_EAST_CORNER_EMPTY,
    NORTH_WEST_CORNER_EMPTY,
    ___UNUSED_18___,

    VERTICAL_TO_SOUTH_EAST_FULL,
    VERTICAL_TO_SOUTH_WEST_FULL,
    ___UNUSED_19___,
    VERTICAL_TO_NORTH_EAST_FULL,
    VERTICAL_TO_NORTH_WEST_FULL,
    ___UNUSED_20___,

    HORIZONTAL_TO_SOUTH_EAST_FULL,
    HORIZONTAL_TO_SOUTH_WEST_FULL,
    ___UNUSED_21___,
    HORIZONTAL_TO_NORTH_EAST_FULL,
    HORIZONTAL_TO_NORTH_WEST_FULL,
    ___UNUSED_22___,

    ALL_JUNCTION_TO_SOUTH_EAST_FULL,
    ALL_JUNCTION_TO_SOUTH_WEST_FULL,
    ___UNUSED_23___,
    ALL_JUNCTION_TO_NORTH_EAST_FULL,
    ALL_JUNCTION_TO_NORTH_WEST_FULL,
    ___UNUSED_24___,

    FULL_TO_SOUTH_EAST_AND_OPPOSITE,
    FULL_TO_SOUTH_WEST_AND_OPPOSITE,
    ___UNUSED_25___,

    BLANK = 255,
}

const NeighborsLookupTable: Record<string, Tiling> = {
    "11011011": Tiling.FULL_TO_SOUTH_WEST_AND_OPPOSITE,
    "01111110": Tiling.FULL_TO_SOUTH_EAST_AND_OPPOSITE,

    "01011011": Tiling.ALL_JUNCTION_TO_SOUTH_EAST_FULL,
    "01011110": Tiling.ALL_JUNCTION_TO_SOUTH_WEST_FULL,
    "01111010": Tiling.ALL_JUNCTION_TO_NORTH_EAST_FULL,
    "11011010": Tiling.ALL_JUNCTION_TO_NORTH_WEST_FULL,

    "01101010": Tiling.VERTICAL_TO_SOUTH_EAST_FULL,
    "01101110": Tiling.VERTICAL_TO_SOUTH_EAST_FULL,
    "11101010": Tiling.VERTICAL_TO_SOUTH_EAST_FULL,
    "11101110": Tiling.VERTICAL_TO_SOUTH_EAST_FULL,

    "11010010": Tiling.VERTICAL_TO_SOUTH_WEST_FULL,
    "11010011": Tiling.VERTICAL_TO_SOUTH_WEST_FULL,
    "11110010": Tiling.VERTICAL_TO_SOUTH_WEST_FULL,
    "11110011": Tiling.VERTICAL_TO_SOUTH_WEST_FULL,

    "01001011": Tiling.VERTICAL_TO_NORTH_EAST_FULL,
    "01001111": Tiling.VERTICAL_TO_NORTH_EAST_FULL,
    "11001011": Tiling.VERTICAL_TO_NORTH_EAST_FULL,
    "11001111": Tiling.VERTICAL_TO_NORTH_EAST_FULL,

    "01010110": Tiling.VERTICAL_TO_NORTH_WEST_FULL,
    "01010111": Tiling.VERTICAL_TO_NORTH_WEST_FULL,
    "01110110": Tiling.VERTICAL_TO_NORTH_WEST_FULL,
    "01110111": Tiling.VERTICAL_TO_NORTH_WEST_FULL,

    "00011110": Tiling.HORIZONTAL_TO_SOUTH_EAST_FULL,
    "00111110": Tiling.HORIZONTAL_TO_SOUTH_EAST_FULL,
    "10011110": Tiling.HORIZONTAL_TO_SOUTH_EAST_FULL,
    "10111110": Tiling.HORIZONTAL_TO_SOUTH_EAST_FULL,

    "00011011": Tiling.HORIZONTAL_TO_SOUTH_WEST_FULL,
    "00111011": Tiling.HORIZONTAL_TO_SOUTH_WEST_FULL,
    "10011011": Tiling.HORIZONTAL_TO_SOUTH_WEST_FULL,
    "10111011": Tiling.HORIZONTAL_TO_SOUTH_WEST_FULL,

    "11011000": Tiling.HORIZONTAL_TO_NORTH_EAST_FULL,
    "11011001": Tiling.HORIZONTAL_TO_NORTH_EAST_FULL,
    "11011100": Tiling.HORIZONTAL_TO_NORTH_EAST_FULL,
    "11011101": Tiling.HORIZONTAL_TO_NORTH_EAST_FULL,

    "01111000": Tiling.HORIZONTAL_TO_NORTH_WEST_FULL,
    "01111001": Tiling.HORIZONTAL_TO_NORTH_WEST_FULL,
    "01111100": Tiling.HORIZONTAL_TO_NORTH_WEST_FULL,
    "01111101": Tiling.HORIZONTAL_TO_NORTH_WEST_FULL,

    "11111010": Tiling.NORTH_TO_SOUTH_JUNCTIONS_FULL,
    "01111011": Tiling.EAST_TO_WEST_JUNCTIONS_FULL,
    "01011111": Tiling.SOUTH_TO_NORTH_JUNCTIONS_FULL,
    "11011110": Tiling.WEST_TO_EAST_JUNCTIONS_FULL,

    "00011010": Tiling.HORIZONTAL_TO_SOUTH_JUNCTION_THIN,
    "00111010": Tiling.HORIZONTAL_TO_SOUTH_JUNCTION_THIN,
    "10011010": Tiling.HORIZONTAL_TO_SOUTH_JUNCTION_THIN,
    "10111010": Tiling.HORIZONTAL_TO_SOUTH_JUNCTION_THIN,

    "01011000": Tiling.HORIZONTAL_TO_NORTH_JUNCTION_THIN,
    "01011001": Tiling.HORIZONTAL_TO_NORTH_JUNCTION_THIN,
    "01011100": Tiling.HORIZONTAL_TO_NORTH_JUNCTION_THIN,
    "01011101": Tiling.HORIZONTAL_TO_NORTH_JUNCTION_THIN,

    "01010010": Tiling.VERTICAL_TO_WEST_JUNCTION_THIN,
    "01010011": Tiling.VERTICAL_TO_WEST_JUNCTION_THIN,
    "01110010": Tiling.VERTICAL_TO_WEST_JUNCTION_THIN,
    "01110011": Tiling.VERTICAL_TO_WEST_JUNCTION_THIN,

    "01001010": Tiling.VERTICAL_TO_EAST_JUNCTION_THIN,
    "01001110": Tiling.VERTICAL_TO_EAST_JUNCTION_THIN,
    "11001010": Tiling.VERTICAL_TO_EAST_JUNCTION_THIN,
    "11001110": Tiling.VERTICAL_TO_EAST_JUNCTION_THIN,

    "00011111": Tiling.NORTH_FULL,
    "00111111": Tiling.NORTH_FULL,
    "10011111": Tiling.NORTH_FULL,
    "10111111": Tiling.NORTH_FULL,

    "01101011": Tiling.WEST_FULL,
    "01101111": Tiling.WEST_FULL,
    "11101011": Tiling.WEST_FULL,
    "11101111": Tiling.WEST_FULL,

    "11111111": Tiling.CENTER_FULL,

    "11010110": Tiling.EAST_FULL,
    "11010111": Tiling.EAST_FULL,
    "11110110": Tiling.EAST_FULL,
    "11110111": Tiling.EAST_FULL,

    "11111000": Tiling.SOUTH_FULL,
    "11111001": Tiling.SOUTH_FULL,
    "11111100": Tiling.SOUTH_FULL,
    "11111101": Tiling.SOUTH_FULL,

    "00001011": Tiling.NORTH_WEST_FULL,
    "00001111": Tiling.NORTH_WEST_FULL,
    "00101011": Tiling.NORTH_WEST_FULL,
    "00101111": Tiling.NORTH_WEST_FULL,
    "10001011": Tiling.NORTH_WEST_FULL,
    "10001111": Tiling.NORTH_WEST_FULL,
    "10101011": Tiling.NORTH_WEST_FULL,
    "10101111": Tiling.NORTH_WEST_FULL,

    "00010110": Tiling.NORTH_EAST_FULL,
    "00010111": Tiling.NORTH_EAST_FULL,
    "00110110": Tiling.NORTH_EAST_FULL,
    "00110111": Tiling.NORTH_EAST_FULL,
    "10010110": Tiling.NORTH_EAST_FULL,
    "10010111": Tiling.NORTH_EAST_FULL,
    "10110110": Tiling.NORTH_EAST_FULL,
    "10110111": Tiling.NORTH_EAST_FULL,

    "01101000": Tiling.SOUTH_WEST_FULL,
    "01101001": Tiling.SOUTH_WEST_FULL,
    "01101100": Tiling.SOUTH_WEST_FULL,
    "01101101": Tiling.SOUTH_WEST_FULL,
    "11101000": Tiling.SOUTH_WEST_FULL,
    "11101001": Tiling.SOUTH_WEST_FULL,
    "11101100": Tiling.SOUTH_WEST_FULL,
    "11101101": Tiling.SOUTH_WEST_FULL,

    "11010000": Tiling.SOUTH_EAST_FULL,
    "11010001": Tiling.SOUTH_EAST_FULL,
    "11010100": Tiling.SOUTH_EAST_FULL,
    "11010101": Tiling.SOUTH_EAST_FULL,
    "11110000": Tiling.SOUTH_EAST_FULL,
    "11110001": Tiling.SOUTH_EAST_FULL,
    "11110100": Tiling.SOUTH_EAST_FULL,
    "11110101": Tiling.SOUTH_EAST_FULL,


    "11111110": Tiling.SOUTH_EAST_CORNER_EMPTY,
    "11111011": Tiling.SOUTH_WEST_CORNER_EMPTY,
    "11011111": Tiling.NORTH_EAST_CORNER_EMPTY,
    "01111111": Tiling.NORTH_WEST_CORNER_EMPTY,

    "00001010": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,
    "00001110": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,
    "00101010": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,
    "00101110": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,
    "10001010": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,
    "10001110": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,
    "10101010": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,
    "10101110": Tiling.SOUTH_TO_EAST_JUNCTION_THIN,

    "00010010": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,
    "00010011": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,
    "00110010": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,
    "00110011": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,
    "10010010": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,
    "10010011": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,
    "10110010": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,
    "10110011": Tiling.SOUTH_TO_WEST_JUNCTION_THIN,

    "01001000": Tiling.NORTH_TO_EAST_JUNCTION_THIN,
    "01001001": Tiling.NORTH_TO_EAST_JUNCTION_THIN,
    "01001100": Tiling.NORTH_TO_EAST_JUNCTION_THIN,
    "01001101": Tiling.NORTH_TO_EAST_JUNCTION_THIN,
    "11001000": Tiling.NORTH_TO_EAST_JUNCTION_THIN,
    "11001001": Tiling.NORTH_TO_EAST_JUNCTION_THIN,
    "11001100": Tiling.NORTH_TO_EAST_JUNCTION_THIN,
    "11001101": Tiling.NORTH_TO_EAST_JUNCTION_THIN,

    "01010000": Tiling.NORTH_TO_WEST_JUNCTION_THIN,
    "01010001": Tiling.NORTH_TO_WEST_JUNCTION_THIN,
    "01010100": Tiling.NORTH_TO_WEST_JUNCTION_THIN,
    "01010101": Tiling.NORTH_TO_WEST_JUNCTION_THIN,
    "01110000": Tiling.NORTH_TO_WEST_JUNCTION_THIN,
    "01110001": Tiling.NORTH_TO_WEST_JUNCTION_THIN,
    "01110100": Tiling.NORTH_TO_WEST_JUNCTION_THIN,
    "01110101": Tiling.NORTH_TO_WEST_JUNCTION_THIN,

    "00011000": Tiling.HORIZONTAL_THIN,
    "00011001": Tiling.HORIZONTAL_THIN,
    "00011100": Tiling.HORIZONTAL_THIN,
    "00011101": Tiling.HORIZONTAL_THIN,
    "00111000": Tiling.HORIZONTAL_THIN,
    "00111001": Tiling.HORIZONTAL_THIN,
    "00111100": Tiling.HORIZONTAL_THIN,
    "00111101": Tiling.HORIZONTAL_THIN,
    "10011000": Tiling.HORIZONTAL_THIN,
    "10011001": Tiling.HORIZONTAL_THIN,
    "10011100": Tiling.HORIZONTAL_THIN,
    "10011101": Tiling.HORIZONTAL_THIN,
    "10111000": Tiling.HORIZONTAL_THIN,
    "10111001": Tiling.HORIZONTAL_THIN,
    "10111100": Tiling.HORIZONTAL_THIN,
    "10111101": Tiling.HORIZONTAL_THIN,

    "01000010": Tiling.VERTICAL_THIN,
    "01000011": Tiling.VERTICAL_THIN,
    "01000110": Tiling.VERTICAL_THIN,
    "01000111": Tiling.VERTICAL_THIN,
    "01100010": Tiling.VERTICAL_THIN,
    "01100011": Tiling.VERTICAL_THIN,
    "01100110": Tiling.VERTICAL_THIN,
    "01100111": Tiling.VERTICAL_THIN,
    "11000010": Tiling.VERTICAL_THIN,
    "11000011": Tiling.VERTICAL_THIN,
    "11000110": Tiling.VERTICAL_THIN,
    "11000111": Tiling.VERTICAL_THIN,
    "11100010": Tiling.VERTICAL_THIN,
    "11100011": Tiling.VERTICAL_THIN,
    "11100110": Tiling.VERTICAL_THIN,
    "11100111": Tiling.VERTICAL_THIN,

    "00000000": Tiling.CENTER_THIN,
    "00000001": Tiling.CENTER_THIN,
    "00000100": Tiling.CENTER_THIN,
    "00000101": Tiling.CENTER_THIN,
    "00100000": Tiling.CENTER_THIN,
    "00100001": Tiling.CENTER_THIN,
    "00100100": Tiling.CENTER_THIN,
    "00100101": Tiling.CENTER_THIN,
    "10000000": Tiling.CENTER_THIN,
    "10000001": Tiling.CENTER_THIN,
    "10000100": Tiling.CENTER_THIN,
    "10000101": Tiling.CENTER_THIN,
    "10100000": Tiling.CENTER_THIN,
    "10100001": Tiling.CENTER_THIN,
    "10100100": Tiling.CENTER_THIN,
    "10100101": Tiling.CENTER_THIN,

    "00000010": Tiling.END_NORTH_JUNCTION_THIN,
    "00000011": Tiling.END_NORTH_JUNCTION_THIN,
    "00000110": Tiling.END_NORTH_JUNCTION_THIN,
    "00000111": Tiling.END_NORTH_JUNCTION_THIN,
    "00100010": Tiling.END_NORTH_JUNCTION_THIN,
    "00100011": Tiling.END_NORTH_JUNCTION_THIN,
    "00100110": Tiling.END_NORTH_JUNCTION_THIN,
    "00100111": Tiling.END_NORTH_JUNCTION_THIN,
    "10000010": Tiling.END_NORTH_JUNCTION_THIN,
    "10000011": Tiling.END_NORTH_JUNCTION_THIN,
    "10000110": Tiling.END_NORTH_JUNCTION_THIN,
    "10000111": Tiling.END_NORTH_JUNCTION_THIN,
    "10100010": Tiling.END_NORTH_JUNCTION_THIN,
    "10100011": Tiling.END_NORTH_JUNCTION_THIN,
    "10100110": Tiling.END_NORTH_JUNCTION_THIN,
    "10100111": Tiling.END_NORTH_JUNCTION_THIN,

    "00001000": Tiling.END_WEST_JUNCTION_THIN,
    "00001001": Tiling.END_WEST_JUNCTION_THIN,
    "00001100": Tiling.END_WEST_JUNCTION_THIN,
    "00001101": Tiling.END_WEST_JUNCTION_THIN,
    "00101000": Tiling.END_WEST_JUNCTION_THIN,
    "00101001": Tiling.END_WEST_JUNCTION_THIN,
    "00101100": Tiling.END_WEST_JUNCTION_THIN,
    "00101101": Tiling.END_WEST_JUNCTION_THIN,
    "10001000": Tiling.END_WEST_JUNCTION_THIN,
    "10001001": Tiling.END_WEST_JUNCTION_THIN,
    "10001100": Tiling.END_WEST_JUNCTION_THIN,
    "10001101": Tiling.END_WEST_JUNCTION_THIN,
    "10101000": Tiling.END_WEST_JUNCTION_THIN,
    "10101001": Tiling.END_WEST_JUNCTION_THIN,
    "10101100": Tiling.END_WEST_JUNCTION_THIN,
    "10101101": Tiling.END_WEST_JUNCTION_THIN,

    "00010000": Tiling.END_EAST_JUNCTION_THIN,
    "00010001": Tiling.END_EAST_JUNCTION_THIN,
    "00010100": Tiling.END_EAST_JUNCTION_THIN,
    "00010101": Tiling.END_EAST_JUNCTION_THIN,
    "00110000": Tiling.END_EAST_JUNCTION_THIN,
    "00110001": Tiling.END_EAST_JUNCTION_THIN,
    "00110100": Tiling.END_EAST_JUNCTION_THIN,
    "00110101": Tiling.END_EAST_JUNCTION_THIN,
    "10010000": Tiling.END_EAST_JUNCTION_THIN,
    "10010001": Tiling.END_EAST_JUNCTION_THIN,
    "10010100": Tiling.END_EAST_JUNCTION_THIN,
    "10010101": Tiling.END_EAST_JUNCTION_THIN,
    "10110000": Tiling.END_EAST_JUNCTION_THIN,
    "10110001": Tiling.END_EAST_JUNCTION_THIN,
    "10110100": Tiling.END_EAST_JUNCTION_THIN,
    "10110101": Tiling.END_EAST_JUNCTION_THIN,

    "01000000": Tiling.END_SOUTH_JUNCTION_THIN,
    "01000001": Tiling.END_SOUTH_JUNCTION_THIN,
    "01000100": Tiling.END_SOUTH_JUNCTION_THIN,
    "01000101": Tiling.END_SOUTH_JUNCTION_THIN,
    "01100000": Tiling.END_SOUTH_JUNCTION_THIN,
    "01100001": Tiling.END_SOUTH_JUNCTION_THIN,
    "01100100": Tiling.END_SOUTH_JUNCTION_THIN,
    "01100101": Tiling.END_SOUTH_JUNCTION_THIN,
    "11000000": Tiling.END_SOUTH_JUNCTION_THIN,
    "11000001": Tiling.END_SOUTH_JUNCTION_THIN,
    "11000100": Tiling.END_SOUTH_JUNCTION_THIN,
    "11000101": Tiling.END_SOUTH_JUNCTION_THIN,
    "11100000": Tiling.END_SOUTH_JUNCTION_THIN,
    "11100001": Tiling.END_SOUTH_JUNCTION_THIN,
    "11100100": Tiling.END_SOUTH_JUNCTION_THIN,
    "11100101": Tiling.END_SOUTH_JUNCTION_THIN,

    "01011010": Tiling.FOUR_WAY_JUNCTION_THIN,
};


export enum TilingTextureMode {
    TEXTURE,
    HEIGHTMAP,
};

export const DungeonTilingStarts: Record<TilingTextureMode, Partial<Record<Tile, number>>> = {
    [TilingTextureMode.HEIGHTMAP]: {
        [Tile.WALL]: 0,
        [Tile.WATER]: 3,
    },
    [TilingTextureMode.TEXTURE]: {
        [Tile.WALL]: 0,
        [Tile.FLOOR]: 9,
        [Tile.WATER]: 0,
    }
};


/** Helper class */
export class DungeonTiling {
    static getTiling(neighbors: boolean[]): number {
        return NeighborsLookupTable[neighbors.map(n => n ? "1" : "0").join("")] ?? Tiling.BLANK;
    }

    /** Generic function for getting texture crops from different parameters */
    static getCrop(
        tiling: Tiling,
        tileType: Tile = Tile.WALL,
        variant: number = 0,
        textureMode: TilingTextureMode = TilingTextureMode.HEIGHTMAP
    ): CropParams {
        const start = DungeonTilingStarts[textureMode][tileType];
        if (start === undefined) throw Error(`No valid texture for this kind of tile ${tileType}`);
        const x = ((tiling % 3) + start + 3 * variant) * 24;
        const y = Math.floor(tiling / 3) * 24;
        return [x, y, 24, 24];
    }
    /** Get the tiling for a tile based on the adjacent tiles
     * @param thisTile The tile to get the tiling for
     * @param neighbors The adjacent tiles
     * @param tile The tile to check for
     * @param ignoreTiles These tiles will create an empty spot in the tiling, as if the tiling was cut off
     * @param includeTiles These tiles will be treated the same as the tile
     */
    static getGridTiling(thisTile: Tile, neighbors: Tile[], tile: number, ignoreTiles: number[] = [], includeTiles: number[] = []) {
        if (!includeTiles.includes(thisTile))
            if (thisTile !== tile)
                return Tiling.BLANK;

        // Convert the adjacent tiles to a boolean if they are the same as the tile
        const neighborsThatEqualToTile = neighbors.map(t => t === tile || ignoreTiles.includes(t));
        // Get the tiling for the neighbors
        return DungeonTiling.getTiling(neighborsThatEqualToTile);
    }
}